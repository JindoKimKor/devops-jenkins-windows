def editMode = "EditMode"
def playMode = "PlayMode"
def util

pipeline {
    agent any

    environment {
        WORKING_DIR = "${WORKSPACE}/Deployment"
        JOB_REPO = "${PR_REPO_HTML}"
        BITBUCKET_ACCESS_TOKEN = credentials('bitbucket-access-token')
    }

    stages {
        stage ('Delete Merged Branch') {
            steps {
                script {
                    util = load("${WORKSPACE}/groovy/pipelineUtil.groovy")
                    def branch_path = sh (script: "/usr/bin/find ../ -type d -name \"${PR_BRANCH}\"", returnStdout: true)
                    branch_path = branch_path.trim()
                    sh "rm -r \"${branch_path}\""
                    sh "rm -r \"${branch_path}@tmp\""
                }
            }
        }
        stage ('Prepare Workspace') {
            environment {
                REPO_SSH = "git@bitbucket.org:${PR_PROJECT}.git"
            }
            steps {
                script {
                    if (!fileExists(WORKING_DIR)) {
                        echo "First time running pipeline. Cloning main branch..."
                        sh "git clone ${REPO_SSH} \"${WORKING_DIR}\""
                    }
                }
                
                dir ("${WORKING_DIR}") {
                    echo "Pulling latest version of default branch..."
                    sh "git pull"
                    script {
                        env.LATEST_COMMIT_HASH = "${sh (script: "git log -n 1 --pretty=format:\"%H\"", returnStdout: true)}"
                    }
                }

                

                
                script {
                    echo "Sending \'In Progress\' status to Bitbucket..."
                    util.sendBuildStatus(WORKSPACE, "INPROGRESS", LATEST_COMMIT_HASH)

                    echo "Identifying Unity version..."
                    env.UNITY_EXECUTABLE = util.getUnityExecutable(WORKSPACE, WORKING_DIR)
                }
            }
        }
        stage ('EditMode Tests') {
            steps {
                echo "Running EditMode tests..."
                dir ("${WORKING_DIR}") {
                    script {
                        exitCode = util.runUnityTests(UNITY_EXECUTABLE, WORKING_DIR, editMode, false)
                        sh "exit ${exitCode}"
                    }
                }
            }
        }
        stage ('PlayMode Tests In Editor'){
            steps {
                echo "Running PlayMode tests..."
                dir ("${WORKING_DIR}") {
                    retry (5) {
                        script {
                            exitCode = util.runUnityTests(UNITY_EXECUTABLE, WORKING_DIR, playMode, false)
                            sh "exit ${exitCode}"
                        }
                    }
                }
            }
        }
        stage ('Build Project') {
            steps {
                echo "Building Unity project for WebGL..."
                sh "mv Builder.cs \"${WORKING_DIR}/Assets/Editor/\""
                dir("${WORKING_DIR}") {
                    retry (3) {
                        script {
                            util.buildProject(UNITY_EXECUTABLE)
                        }
                    }
                }
            }
        }
        stage ('Deploy Build') {
            steps {
                echo "Deploying build to LTI web server..."

                script {
                    def folderName = "${JOB_NAME}".split('/').first()
                    sh "ssh vconadmin@dlx-webhost.canadacentral.cloudapp.azure.com \"sudo mkdir -p /var/www/html/${folderName}\""
                    sh "scp -i C:/Users/ci-catherine/.ssh/vconkey1.pem -rp \"${WORKING_DIR}/Builds/*\" \"vconadmin@dlx-webhost.canadacentral.cloudapp.azure.com:/var/www/html/${folderName}\""
                }
            }
        }
    }

    post {
        success {
            script {
                util.sendBuildStatus(WORKSPACE, "SUCCESSFUL", LATEST_COMMIT_HASH)
            }
        }
        failure {
            script {
                util.sendBuildStatus(WORKSPACE, "FAILED", LATEST_COMMIT_HASH)
            }
        }
        aborted {
            script {
                util.sendBuildStatus(WORKSPACE, "STOPPED", LATEST_COMMIT_HASH)
            }
        }
    }
}